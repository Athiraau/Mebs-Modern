@{
    ViewData["Title"] = "GRIEVANCEREGISTER";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRIEVANCE REGISTER</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="~/css/index.css">
    <script src="~/js/site.js"></script>
    <style>
        .container {
            max-width: 100%;
            margin: 40px auto;
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 6px 10px;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            background-color: #538392;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-group .btn {
            margin: 0 50px;
        }

        .form-control {
            height: 30px;
            font-size: small;
        }

        .form-label {
            font-weight: 500;
            font-size: small;
            color: #27005D;
        }

        .label1 {
            font-size: 12px;
        }

        .card-header {
            background-color: #538392;
            color: white;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .fw {
            font-weight: 600;
        }

        .table {
            font-size: 10px; /* Reduced font size */
        }

            .table th, .table td {
                border: 1px solid;
                padding: 5px; /* Reduced padding */
            }

            .table td {
                vertical-align: middle;
            }

            .table th {
                background-color: #538392;
                color: #ffff;
            }

        .card-details {
            color: 2px solid;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            margin-top: 5px;
        }

        .btn {
            display: inline-block;
            padding: 6px 10px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            background-color: #538392;
            border-radius: 5px;
            border: none;
            color: white;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
            font-size: 10px;
        }

        .btn-group .btn {
            margin: 0 50 px;
        }

        .cls_test {
            font-size: 11px;
            height: 38px;
            color: #686D76;
        }

        .radio {
            display: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>


    <div class="pagecontiner">
        <div class="container">
            <div class="card p-3" style="width:100%;">
                <div class="card-header">
                    <center><h5 class="mb-0"><i class="fa-solid fa-book"></i> GRIEVANCE REGISTER</h5></center>
                </div>
                <div class="form-group row mt-3 fw">
                    <label class="col-sm-2 col-form-label form-label fw">Emp Code</label>
                    <div class="col-sm-4">
                        <input type="text" id="emp-code" class="form-control" readonly />
                    </div>
                    <label class="col-sm-2 col-form-label form-label fw">Emp Name</label>
                    <div class="col-sm-4">
                        <input type="text" id="emp-name" class="form-control" readonly />
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-2 col-form-label form-label fw">Branch</label>
                    <div class="col-sm-4">
                        <input type="text" id="branch" class="form-control" readonly />
                    </div>
                    <label class="col-sm-2 col-form-label form-label fw">Department</label>
                    <div class="col-sm-4">
                        <input type="text" id="department" class="form-control" readonly />
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-2 col-form-label form-label fw">Designation</label>
                    <div class="col-sm-4">
                        <input type="text" id="designation" class="form-control" readonly />
                    </div>
                    <label class="col-sm-2 col-form-label form-label fw">post</label>
                    <div class="col-sm-4">
                        <input type="text" id="post" class="form-control" readonly />
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-2 col-form-label form-label fw">Mobile NO</label>
                    <div class="col-sm-4">
                        <input type="text" id="mobile" class="form-control" onchange="validatePhoneNumber();" maxlength="10" />
                        <p id="error-message" style="color: red;"></p>
                    </div>

                    <label class="col-sm-2 col-form-label form-label fw">Date</label>
                    <div class="col-sm-4">
                        <input type="text" name="frmDateReg" required id="frmDate" class="form-control" readonly>

                    </div>
                </div>


                <div class="form-group row">
                    <label class="col-sm-2 col-form-label form-label fw">Email Id</label>
                    <div class="col-sm-4">
                        <input type="text" id="email" class="form-control" onchange="emailcheck();" />
                        <p id="error-message1" style="color: red;"></p>
                    </div>
                    <label class="col-sm-2 col-form-label form-label fw">Branch Outlook Email Id</label>
                    <div class="col-sm-4">
                        <input type="email" id="br_emailid" class="form-control" onchange="emailcheck1();" />
                        <p id="error-message2" style="color: red;"></p>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-2 col-form-label form-label fw">Nature of Issue</label>
                    <div class="col-sm-8">
                        <select id="nature_issue" class="form-control form-label cls_test">
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-8 col-form-label form-label fw" style="color:red">Note :Are you directly appling without informing concerned authority?</label>
                    <div class="col-sm-3">
                        <div class="form-check form-check-inline form-label fw">
                            <input class="form-check-input" type="radio" name="RadioOption" id="Y" value="Y" onclick="OnClickRadioYes();">
                            <label class="form-check-label" for="Radio1" style="font-size:small">Yes</label>
                        </div>
                        <div class="form-check form-check-inline form-label fw">
                            <input class="form-check-input" type="radio" name="RadioOption" id="N" value="N" onclick="OnClickRadioNo();">
                            <label class="form-check-label" for="Radio2" style="font-size:small">No</label>
                        </div>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-2 col-form-label form-label fw">Description</label>
                    <div class="col-sm-8">
                        <textarea id="describe" class="form-control" onchange="TextonCheck();" style="height:100PX"></textarea>
                    </div>
                </div>
                <div><br /></div>
                <div class="form-group row">
                    <label for="grievenceInput" class="col-sm-3 col-form-label form-label fw">Upload Document</label>
                    <div class="col-sm-6">
                        <input type="file" id="grievenceInput" class="form-control-file label1">
                    </div>
                </div>
                <div class="m-3 text-center">
                    <button type="button" id="Submit" class="btn btn-dark mx-1" onclick="submit();" style="font-size:14px;">Submit</button>
                    <button type="button" id="Exit" class="btn btn-dark mx-1" onclick="loadIndex();" style="font-size:14px;">Exit</button>
                </div>
            </div>

        </div>
        <input type="text" id="base64Input" style="display:none;">
    </div>


    <script>

        // ---------------------------------------ONLOAD FUNCTION-----------------------------------------------------------------

        window.onload = function OnloadFunction() {
            //current date
            const dateTextbox = document.getElementById('frmDate');
            const currentDate = new Date();
            const day = String(currentDate.getDate()).padStart(2, '0');
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const year = currentDate.getFullYear();
            const formattedDate = `${day}-${month}-${year}`;
            dateTextbox.value = formattedDate;


            // Employee Details

            GetEmpDetails();


            // Dropdown

            callNatureIssueApi();

        }

        // --------------------------------------- Employee Details -----------------------------------------------------------------

        function GetEmpDetails() {
            var _link = '';
            if (document.location.hostname == 'localhost') { _link = "/Others/getAPIData"; }
            else { var root = '@ViewData["root"]'; _link = "/" + root + "/Others/getAPIData"; }
            var EmpCode = '@ViewData["EmpCode"]';


            indata = "PROC_HRMS_COMMON_MVC" + "^" + 2 + "~" + 1 + "~" + EmpCode;
            var response = '';
            $.ajax({
                type: "GET",
                url: _link,
                data: { datas: indata },
                async: false,
                success: function (response) {
                    const Edetails = JSON.parse(response);
                    LoadEmployeeDetails(Edetails);
                },
                error: function (response) {
                }
            });
        }

        // --------------------------------------- Load Employee Details -----------------------------------------------------------------


        function LoadEmployeeDetails(Edetails) {
            // initializing Values to the variables

            EmployeeCode = Edetails[0].EMP_CODE;
            EmployeeName = Edetails[0].EMP_NAME;
            Branch = Edetails[0].BRANCH_NAME;
            Department = Edetails[0].DEP_NAME;
            Designation = Edetails[0].DESIGNATION;
            Post = Edetails[0].POST_NAME;


            // initializing Values to the textbox

            document.getElementById('emp-code').value = EmployeeCode;
            document.getElementById('emp-name').value = EmployeeName;
            document.getElementById('branch').value = Branch;
            document.getElementById('department').value = Department;
            document.getElementById('designation').value = Designation;
            document.getElementById('post').value = Post;

        }


        // --------------------------------------- nature of issue -----------------------------------------------------------------


        function callNatureIssueApi() {

            var _link = '';
            if (document.location.hostname == 'localhost') { _link = "/Others/getAPIData"; }
            else { var root = '@ViewData["root"]'; _link = "/" + root + "/Others/getAPIData"; }
            var EmpCode = '@ViewData["EmpCode"]';

            indata = "PROC_HRMS_COMMON_MVC" + "^" + 2 + "~" + 2;

            var response = '';
            $.ajax({
                type: "GET",
                url: _link,
                data: { datas: indata },
                async: false,
                success: function (response) {

                    const data2 = JSON.parse(response);
                    LoadnatureIssue(data2);
                },
                error: function (response) {
                    alert("failed");
                }
            });
        }

        // --------------------------------------- Load DropDown nature Api -----------------------------------------------------------------


        function LoadnatureIssue(data) {
            var NatureTypeDrop = document.getElementById('nature_issue');
            const options = formatDataAsArray_Nature_Type(data);
            NatureTypeDrop.innerHTML = '';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.text = option.label;
                NatureTypeDrop.add(optionElement);
            });
        }

        function formatDataAsArray_Nature_Type(data) {
            if (Array.isArray(data) && data.length > 0) {
                return data.map(item => ({
                    value: item["STATUS_ID"],
                    label: item["DESCRIPTION"]
                }));
            } else {
                return [];
            }
        }



        //  ------------------------------upload------------------------------------------------

        const grievenceInput = document.getElementById('grievenceInput');
        const base64Input = document.getElementById('base64Input');
        var docTyp = "0";
        var fileExtension = "";

        grievenceInput.addEventListener('change', function () {


            const file = this.files[0];
            const reader = new FileReader();

            // Check if the file is a PDF or an image (JPEG/PNG)
            if (!['application/pdf', 'image/jpg'].includes(file.type)) {
                alert('Only PDF and JPG files are allowed');
                docTyp = "1";
                return;
            } else {
                docTyp = "0";
            }

            const maxSizeInBytes = 200 * 1024; // 200KB in bytes
            if (file.size > maxSizeInBytes) {
                alert('File size must be less than 200KB');
                document.getElementById('grievenceInput').value = "";
                return false;
            }


            if (file.type === 'application/pdf') {
                fileExtension = "pdf";
            }
            else if (file.type === 'image/jpg') {
                fileExtension = "jpg";
            }
           
            reader.onload = function (event) {
                const base64Url = event.target.result;
                base64Input.value = base64Url;
            };

            reader.readAsDataURL(file);

        });

        function UploadDocument() {

            var fileInput = document.getElementById('grievenceInput');
            var filePath = fileInput.value;
            if (!fileInput.files.length) {

                return false;
            }

            var emp_code = document.getElementById('emp-code').value;
            var ration_type = emp_code + "_" + "Ration" + fileExtension;


            var base64Input = document.getElementById('base64Input').value;
            var base64Data = documentBase64(base64Input);
            base64Data = base64Data.replace("\"", "");
           

            var query = "update dms.tbl_esi_doc_upload t set t.ration_card=:DOCUMENT,t.ration_type='" + ration_type + "',t.upt_date=sysdate where t.emp_code=" + emp_code;

            query = query.replace("\"", " ");
            query = query.replace("\"'", "\'");
            PostDocumentAPICall(query, base64Data);
        }

        function documentBase64(base64Input) {
            var resp = JSON.stringify(base64Input);


            resp = resp.replace("data:application/pdf;base64,", "");
            resp = resp.replace("data:image/jpg;base64,", "");

            resp = resp.replace("\'", "");

            return resp;
        }

        function PostDocumentAPICall(query, base64Data) {
            var _link = '';
            if (document.location.hostname == 'localhost') {
                _link = "/Others/DocumentUpload";
            } else {
                var root = '@ViewData["root"]';
                _link = "/" + root + "/Others/DocumentUpload";
            }

            var indata1 = query + '~' + base64Data;

            indata1 = indata1.replace("\"", "");
            indata1 = indata1.replace("\"'", "\'");

            $.ajax({
                type: "POST",
                url: _link,
                data: { datas: indata1 },
                async: false,
                success: function () {
                    alert("Document uploaded successfully");
                },
                error: function (response) {
                    check = 0;
                }
            });
        }
        //---------------------------------------submit-----------------------------------------------------------------------

        function submit() {


            if (!validates()) {
                return false;
            }

            var emp_code = document.getElementById('emp-code').value;
            var branch = document.getElementById('branch').value;
            var nature_issue = document.getElementById('nature_issue').value;
            var mobile = document.getElementById('mobile').value;
            var email = document.getElementById('email').value;
            var br_email = document.getElementById('br_emailid').value;
            var desc = document.getElementById('describe').value;
            var branch = '@ViewData["BrID"]';

            indata = branch + "~" + emp_code + "~" + nature_issue + "~" + mobile + "~" + email + "~" + br_email + "~" + desc;

            PostDataAPICall(indata);



        }

        function PostDataAPICall(indata) {


            input = "PROC_HRMS_COMMON_MVC" + "^" + 2 + "~" + 3 + "~" + indata;

            var _link = '';
            if (document.location.hostname == 'localhost') { _link = "/Others/postAPIData"; }
            else { var root = '@ViewData["root"]'; _link = "/" + root + "/Others/postAPIData"; }

            const a = "";
            $.ajax({
                type: "POST",
                url: _link,
                data: { datas: input },
                async: false,
                success: function (response) {
                    response = JSON.parse(response);

                    result = response[0].RESULT;

                   

                    if (result === "THE  COMPLAINT ALREADY  ENTERED") {
                        alert(result);
                        resetForm();
                    }
                    else {
                        alert(result);
                        UploadDocument();
                        resetForm();
                    }



                },
                error: function (response) {
                    check = 0;
                    alert("failed");
                }
            });

        }



        function resetForm() {
            var root = '';
            var baselink = '@ViewData["baseurl"]';
            var id = '@ViewData["HeadName"]';

            if (document.location.hostname == 'localhost') {
                window.location.href = "/Others/GRIEVANCEREGISTER?datas=" + id;
            }
            else {
                root = '@ViewData["root"]';
                domainurl = baselink + root;
                window.location.href = domainurl + "/Others/GRIEVANCEREGISTER?datas=" + id;
            }


        }

        // ---------------------------------------validate----------------------------------------------------------------



        //---------VALIDATION----------------------//


        function validates() {
            //  DTValidation();
            var nature_issue = document.getElementById('nature_issue');
            var mobile = document.getElementById("mobile");
            var email = document.getElementById("email");
            var br_email = document.getElementById("br_emailid");
            var desc = document.getElementById("describe");
            var radios = document.getElementsByName('RadioOption');
            var formValid = false;



            for (var i = 0; i < radios.length; i++) {
                if (radios[i].checked) {
                    formValid = true;
                    break;
                }
            }




            if (!validText(mobile)) {
                alert("Please enter Mobile number.");
                return false;
            }

            else if (!validText(email)) {
                alert("Please enter email id.");
                return false;
            }
            else if (!validText(br_emailid)) {
                alert("Please enter branch mail id.");
                return false;
            }
            else if (!validateSelect(nature_issue)) {
                alert("Please select a nature of issue.");
                return false;
            }

            else if (!formValid) {
                alert("Please select an option.");
                return false;
            }
            else if (!validText(desc)) {
                alert("Please enter description.");
                return false;
            }


            return true;



        }

        function validateSelect(select) {
            if (select.selectedIndex === 0) {
                return false;
            }
            return true;
        }


        function validText(input) {
            if (input.value === "") {
                return false;
            }
            return true;
        }







    </script>

    <script>

        // ----------------------------------




        function validatePhoneNumber() {
            const phoneInput = document.getElementById('mobile').value;
            const errorMessage = document.getElementById('error-message');


            const phoneRegex = /^\d{10}$/;

            if (!phoneRegex.test(phoneInput)) {
                errorMessage.textContent = 'Please enter a valid 10-digit phone number.';
                document.getElementById('mobile').value = "";
                document.getElementById('mobile').focus();
                return false;
            } else {
                errorMessage.textContent = '';
                return true;
            }
        }

        function emailcheck() {


            email = document.getElementById('email').value;


            const errorMessage = document.getElementById('error-message1');

            const res1 = EmailPatternValidation(email);

            if (res1 == 0) {
                errorMessage.textContent = 'Please enter a valid Email Id.';
                document.getElementById('email').value = "";
                document.getElementById('email').focus();

                return false;
            }
            else {
                errorMessage.textContent = '';

                return true;
            }

        }



        function emailcheck1() {

            email = document.getElementById('br_emailid').value;

            const errorMessage = document.getElementById('error-message2');

            const res1 = EmailPatternValidation(email);



            if (res1 == 0) {
                errorMessage.textContent = 'Please enter a valid Email Id.';
                document.getElementById('br_emailid').value = "";
                document.getElementById('br_emailid').focus();

                return false;
            }
            else {
                errorMessage.textContent = '';

                return true;
            }

        }


        function EmailPatternValidation(indata) {
            var _link = '';
            if (document.location.hostname == 'localhost') { _link = "/Others/EmailPatternValidation"; }
            else { var root = '@ViewData["root"]'; _link = "/" + root + "/Others/EmailPatternValidation"; }

            var data2 = '';
            var response = '';
            $.ajax({
                type: "GET",
                url: _link,
                data: { datas: indata },
                async: false,
                success: function (response) {

                    data2 = response;

                },
                error: function (response) {
                    alert("failed");
                }
            });


            return data2;

        }

        //----redirect to index page

        function loadIndex() {

            var root = '';
            var baselink = '@ViewData["baseurl"]';
            var id = '@ViewData["HeadName"]';

            if (document.location.hostname == 'localhost') {
                window.location.href = "/Others/Index?datas=" + id;
            }
            else {
                root = '@ViewData["root"]';
                domainurl = baselink + root;
                window.location.href = domainurl + "/Others/Index?datas=" + id;
            }

        }




        function OnClickRadioYes() {
            if (document.getElementById('Y').checked == true && document.getElementById('N').checked == false) {
                alert("PLEASE CONTANCT WITH CONCERNED AUTHORITY FIRST");
                loadIndex();
                return false;

            }
        }

        function OnClickRadioNo() {
            if (document.getElementById('Y').checked == false && document.getElementById('N').checked == true) {

                alert("PLEASE  ENTER WITH WHOM ARE YOU CONTACT? DEPARTMENT? NAME OF PERSON? DATE? WITH  BRIEF DESCRIPTION");

            }
        }

        function TextonCheck() {
            if (document.getElementById('describe').value.length < 100) {
                alert('Please  Enter the character atleast 50 Words in Breifly');

                return false;
            }

        }





    </script>

</body>
</html>

